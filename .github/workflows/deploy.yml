name: Deploy to Railway

on:
    push:
      branches: [ main ]
        pull_request:
            branches: [ main ]

            jobs:
              deploy:
                  runs-on: ubuntu-latest

                          steps:
                              - name: Checkout code
                                    uses: actions/checkout@v4

                                              - name: Setup Node.js
                                                    uses: actions/setup-node@v4
                                                          with:
                                                                  node-version: '20'
                                                                          cache: 'npm'

                                                                                      - name: Install dependencies
                                                                                            run: npm ci

                                                                                                      - name: Run tests (if available)
                                                                                                            run: npm test --if-present
                                                                                                                  
                                                                                                                      - name: Deploy to Railway
                                                                                                                            run: npx -y railway up --yes
                                                                                                                                  env:
                                                                                                                                          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
                                                                                                                                                  
                                                                                                                                                      - name: Verify deployment
                                                                                                                                                            run: |
                                                                                                                                                                    echo "Deployment completed at $(date)"
                                                                                                                                                                            echo "Waiting 30 seconds for Railway to process deployment..."
                                                                                                                                                                                    sleep 30
                                                                                                                                                                                            echo "Testing deployment endpoints..."
                                                                                                                                                                                                    curl -f https://autoapply-production.up.railway.app/health || echo "Health endpoint not ready yet"
                                                                                                                                                                                                            curl -f https://autoapply-production.up.railway.app/test-deployment || echo "Test deployment endpoint not ready yet"
